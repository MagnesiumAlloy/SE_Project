<link rel="stylesheet" type="text/css" href="static/css/main.css" />
<html>

<head>
  <meta charset="UTF-8">
  <title>文件浏览</title>
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js">
  </script>

  <script src="static/js/myfile.js">
  </script>

  <script>
    function recover() {// 对文件进行恢复
      const desName = document.getElementById('desName').value;
      const desPath = document.getElementById('desPath').value;
      const srcName = document.getElementById('srcName').value;
      const srcPath = document.getElementById('srcPath').value;
      $.ajax({
        url: "/recover",
        type: "POST",
        data: {
          srcName: srcName,
          srcPath:srcPath,
          desPath: desPath
        },
        datatype: "json",
        success: function (res) {
          console.log(res);
          if (res.status == 200) {
            alert("恢复成功");
            top.location.href="/myfile";
          }
        },
        error: function (res) {
          alert("恢复失败");
        }
      });
      return false;
    };

    function compare() {
      const desName = document.getElementById('desName').value;
      const desPath = document.getElementById('desPath').value;
      const srcName = document.getElementById('srcName').value;
      const srcPath = document.getElementById('srcPath').value;
      $.ajax({
        url: "/compare",
        type: "POST",
        dataType: "json",
        data: {
          desName: desName,
          desPath: desPath,
          srcName: srcName,
          srcPath: srcPath
        },
        success: function (data) {
          console.log(data);
          if (data.status == 200) {
            alert("两文件相同")
          } else {
            alert("两文件不同");
          }
        }
      })
    };

    function Delete() {
      const srcName = document.getElementById('srcName').value;
      const srcPath = document.getElementById('srcPath').value;
      $.ajax({
        url: "/delete"+"?name="+srcName+"&path="+srcPath,
        type: "DELETE",
        dataType: "json",
        success: function (data) {
          console.log(data);
          if (data.status == 200) {
            alert("删除成功");
            top.location.href = '/myfile';
          } else {
            alert("删除失败");
          }
        }
      })
    };


    function readDir(isroot,name,path) {
      $.ajax({
        url: "/readDir",
        type: "GET",
        dataType: "json",
        data: {
          path: path,
          name: name,
          isroot: isroot
        },
        success: function (data) {
          console.log(data);
          showTable(data.data,isroot);
        }
      })
    };

    function Last(obj,isroot)  {
      let node = obj;
      let filename = node.parentElement.parentElement.children[1].innerHTML;
      let filepath = node.parentElement.parentElement.children[4].innerHTML;
      //alert(id,filepath,filetype);
      console.log(filename);
      console.log(filepath);
      let ii=0,point=-1;
      for(let i=filepath.length-1;i>=0;i--){
        if (filepath[i]!='/') continue;
        else {
          ii++;
        }
        if(ii==3){
          point=i;
          break;
        }
      } 
      let filepath1="";
      let filename1="";
      ii=0;
      for(let i=point+1;;i++){
        if(filepath[i]=="/"){
          break;
        }
        filename1+=filepath[i];
      }
      for(let i=0;i<=point;i++){
        filepath1+=filepath[i];
      }
      
      console.log(filepath1);
      console.log(filename1);
      $.ajax({
        url: "/readDir",
        type: "GET",
        dataType: "json",
        data: {
          path: filepath1,
          name: filename1,
          isroot: isroot
        },
        success: function (data) {
          console.log(data);
          showTable(data.data,isroot);
        }
      })
    };

    function showTable(arr,isroot) {
      var out = "";
      for (let i = 0; i < arr.length; i++) {
        if (arr[i].Name == "") continue;
        if(arr[i].Type !="dir"&&!isroot) continue;
        out += "<tr>"
          +"<td><button type=button class= "+"hiddenbox "+"onclick="+"select(this,"+isroot+")"+">选择</button></td>"
          + "<td onclick=" + "explore(this,"+isroot+")"+">" + arr[i].Name + "</td>"
          + "<td>" + arr[i].ModTime + "</td>"
          + "<td>" + arr[i].Size + "</td>"
          + "<td hidden=true>" + arr[i].Path + "</td>"
          + "<td hidden=true>" + arr[i].Type + "</td>"
          +"<td><button type=button class= "+"hiddenbox "+"onclick="+"Last(this,"+isroot+")"+">返回上一级</button></td>"
          + "</tr>";
      }
      document.getElementById("content").innerHTML = out;
    }

    function explore(obj,isroot) {
      let node = obj;
      let filename = node.parentElement.children[1].innerHTML;
      let filetype = node.parentElement.children[5].innerHTML;
      let filepath = node.parentElement.children[4].innerHTML;
      //alert(id,filepath,filetype);
      if (filetype == "dir") { //文件夹类型,要你指定
        //更进一步
        readDir(isroot,filename,filepath);
      } else {
        if(isroot){
          console.log(filepath);
          document.getElementById('srcName').value=filename;
          document.getElementById('srcPath').value=filepath;
        } else {
          console.log(filepath);
          document.getElementById('desPath').value=filepath+filename+"/";
        }
      }
    }


    function select(obj,isroot) {
      let node = obj;
      let filename = node.parentElement.parentElement.children[1].innerHTML;
      let filetype = node.parentElement.parentElement.children[5].innerHTML;
      let filepath = node.parentElement.parentElement.children[4].innerHTML;
      //alert(id,filepath,filetype);
        if(isroot){
          document.getElementById('srcName').value=filename;
          document.getElementById('srcPath').value=filepath;
        } else {
          document.getElementById('desPath').value=filepath+filename+"/";
        }
    }

  </script>

  <style>
    td {
      width: 200px;
      text-align: center;
      padding: 10px;
    }

    table {
      font-size: 1.5em;
      margin: auto;
    }

    body {
      background-image: linear-gradient(#e66465, #9198e5);
      background-size: 100% 100%;
      background-attachment: fixed;
      background-repeat: no-repeat;
      background-position: center center;
    }

    form.special {
      width: 100%;
      margin: auto;
      margin-top: 40px;
      font-size: 1.5em;
      text-align: center;
    }

    table {
      font-size: 1.5em;
      margin: auto;
      margin-bottom: 10em;
    }

    input.page {
      border-radius: 7px;
      padding: 5px;
      margin-bottom: 4em;
      margin-left: 1em;
      font-size: 0.7em;
    }

    div.columns {
      column-count: 2;
      column-gap: 40px;
      column-rule-style: dotted;
    }

    input.page[type=submit] {
      background-color: #d44773;
      transition-duration: 0.4s;
      box-shadow: 0 6px #999;
      font-weight: bold;
      padding: 14px 20px;
      margin: 8px 15px;
      border: none;
      border-radius: 6px;
      clear: both;
    }

    input.page[type=button]:hover {
      background-color: #f1dd78;
    }

    input.page[type=button] {
      background-color: #d44773;
      transition-duration: 0.4s;
      box-shadow: 0 6px #999;
      font-weight: bold;
      padding: 14px 20px;
      margin: 8px 15px;
      border: none;
      border-radius: 6px;
      clear: both;
    }

    input.page[type=submit]:hover {
      background-color: #f1dd78;
    }

    *:focus {
      background-color: #f6f607;
    }

    body {
      background-image: linear-gradient(#e66465, #9198e5);
      background-size: 100% 100%;
      background-attachment: fixed;
      background-repeat: no-repeat;
      background-position: center center;
    }


    .fileInputContainer {
      height: 256px;
      background: url(static/img/uploadfolder.png);
      position: relative;
      width: 256px;
    }

    .fileInput {
      height: 256px;
      overflow: hidden;
      font-size: 300px;
      position: absolute;
      right: 0;
      top: 0;
      opacity: 0;
      filter: alpha(opacity=0);
      cursor: pointer;
    }


  </style>

</head>

<body>


  <ul class="nav1" class="out">
    <li class="border1">
      <a class="li1" href="/zhuye">用户主界面</a>
    </li>

    <li class="border1">
      <a href="#">基本功能</a>
      <ul class="nav2">
        <li>
          <a href="#">我的文件</a>
          <ul class="nav3">
            <li>
              <!--            根据当前用户的id，返回其仓库的文件-->
              <form id="user1">
                <a class="kuang" type="button" name="flag" value="私密上传" href='/myfile'>文件浏览</a>
              </form>
            </li>
            <li>
              <form id="user2">
                <a class="kuang" type="button" name="flag" value="私密上传" href='/secret'>加密备份</a>
              </form>
            </li>

            <li>
              <form id="user3">
                <a class="kuang" type="button" name="flag" value="私密上传" href='/normal'>普通备份</a>
              </form>
            </li>

            <li>
              <form id="user4">
                <a class="kuang" type="button" name="flag" value="私密上传" href='/recycle'>我的回收</a>
              </form>
            </li>

          </ul>
        </li>
      </ul>
    </li>

    <li class="border1">
      <a href="/Modify">修改密码</a>
    </li>

    <li class="border1">
      <a href="/about">关于我们</a>
    </li>

    <li class="border1">
      <a href="/">退出系统</a>
    </li>

  </ul>
  <br>

  <div>
    <form class="special">
    <input class="page" type="button" name="button" value="选择恢复文件" onclick="readDir(1,'','')">
    <input class="page" type="button" name="button" value="选择恢复路径" onclick="readDir(0,'','')">
    </form>
    
    <form class="special">

      <input class="page" type="text" size="20" name="error" id="error" value="${error}" hidden>

      <p><input hidden="true" class="page" type="text" size="20" name="fileName" id="srcPath"></p>
      <p>文件：<input class="page" type="text" size="20" name="pathfileName" id="srcName"></p>

      <p>恢复路径：<input class="page" type="text" size="20" name="fileName" id="desPath"></p>
      <p><input hidden="true" class="page" type="text" size="20" name="pathfileName" id="desName"></p>

      <input class="page" type="button" name="button" value="恢复" onclick="recover()">
      <!-- <input class="page" type="button" name="button" value="比较" onclick="compare()"> -->
      <input class="page" type="button" name="button" value="删除备份" onclick="Delete()">

    </form>
  </div>
  <div><input class="fileInput" id="fileUpload" type="file" name="button" style="display: none;"
      onchange="getFile(value)"></div>

  <table border="5">
    <tr>
      <th class="firstC"></th>
      <th>文件名称</th>
      <th>修改时间</th>
      <th>文件大小</th>
    </tr>
    <tbody id="content">

    </tbody>
  </table>


</body>

</html>